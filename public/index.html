<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div id="message">
      <h2>Firebase auth example</h2>

      <button id="logout">Logout</button>
      <button id="anonLogin">Anonymous Login</button>
      <button id="googleLogin">Google Login</button>
      <div class="loggedIn">
        <div>Display Name: <span id="displayName"></span></div>
        <div>Anonymous: <span id="anonymous"></span></div>
        <div>Email: <span id="email"></span></div>
        <div>Photo: <img width="40" src="" id="photo"/></div>
        <div>Uid: <span id="uid"></span></div>
      </div>
      <div>User Data <span id="userData"></span></div>
      <div>Put an item in your cart! <button onclick="addItem()">Click here</button></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/4.10.0/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyCSq8J0nx8B-Q7g_xw4p3nlnf7w_M4OVDI",
            authDomain: "ns-test-project.firebaseapp.com",
            databaseURL: "https://ns-test-project.firebaseio.com",
            projectId: "ns-test-project",
            storageBucket: "",
            messagingSenderId: "441164425469"
        };
        var app = firebase.initializeApp(config);

        console.log("app initialized:",app);

        var email = "emoore@nuskin.com";
        var password = "abc123";

        var logoutBtn = document.getElementById("logout");
        var loginAnon = document.getElementById("anonLogin");
        var loginGoogle = document.getElementById("googleLogin");

        logoutBtn.addEventListener("click", function(e) {
            console.log("Clicked logout");
            firebase.auth().signOut();
        });

        loginAnon.addEventListener("click", function(e) {
            firebase.auth().signInAnonymously().then(function(data) {
                console.log("Anonymous login");
            }).catch(function(error) {
                // Handle Errors here.
                var errorCode = error.code;
                var errorMessage = error.message;
                // ...
            });
        });

        loginGoogle.addEventListener("click", function(e) {
            var provider = new firebase.auth.GoogleAuthProvider();

           firebase.auth().signInWithPopup(provider).then(function(result) {
               // This gives you a Google Access Token. You can use it to access the Google API.
               var token = result.credential.accessToken;
               // The signed-in user info.
               var user = result.user;
               console.log("Logged in with google. token:",token+" user:",user);
               // ...
           }).catch(function(error) {
               // Handle Errors here.
               var errorCode = error.code;
               var errorMessage = error.message;
               // The email of the user's account used.
               var email = error.email;
               // The firebase.auth.AuthCredential type that was used.
               var credential = error.credential;
               console.log("Error logging in with google:",errorMessage);
               // ...
           });
        });







//        var provider = new firebase.auth.GoogleAuthProvider();
//
//        firebase.auth().signInWithPopup(provider).then(function(result) {
//            // This gives you a Google Access Token. You can use it to access the Google API.
//            var token = result.credential.accessToken;
//            // The signed-in user info.
//            var user = result.user;
//            console.log("Logged in with google. token:",token+" user:",user);
//            // ...
//        }).catch(function(error) {
//            // Handle Errors here.
//            var errorCode = error.code;
//            var errorMessage = error.message;
//            // The email of the user's account used.
//            var email = error.email;
//            // The firebase.auth.AuthCredential type that was used.
//            var credential = error.credential;
//            console.log("Error logging in with google:",errorMessage);
//            // ...
//        });

//        /**
//         * CREATE USER
//         */
//        firebase.auth().createUserWithEmailAndPassword(email, password).then(function(res) {
//            console.log("created");
//        }).catch(function(error) {
//            // Handle Errors here.
//            var errorCode = error.code;
//            var errorMessage = error.message;
//            console.log("Error creating:",errorMessage);
//            // ...
//        });
//
//
//        /**
//         * LOGIN USER
//         */
//        firebase.auth().signInWithEmailAndPassword(email, password).then(function(res) {
//            console.log("Logged in");
//
//        }).catch(function(error) {
//            // Handle Errors here.
//            var errorCode = error.code;
//            var errorMessage = error.message;
//            console.log("Error logging in:",errorMessage);
//            // ...
//        });

        /**
         * AUTH STATE LISTENER
         */
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                // User is signed in.
                var displayName = user.displayName;
                var email = user.email;
                var emailVerified = user.emailVerified;
                var photoURL = user.photoURL;
                var isAnonymous = user.isAnonymous;
                var uid = user.uid;
                var providerData = user.providerData;

                myuser = {
                    displayName: displayName,
                    email: email,
                    emailVerified: emailVerified,
                    photoURL: photoURL,
                    anonymous: isAnonymous,
                    uid: uid,
                    providerData: providerData
                }



                //document.getElementById("loggedIn").style.display = "block";
                updateUserData();
                loadUserData();
                console.log("Logged in. myuser",myuser);

                // ...
            } else {
                // User is signed out.
                // ...
                console.log("Signed out");
                myuser = {};
                updateUserData();
            }
        });

        function updateUserData() {
            document.getElementById("displayName").innerHTML = myuser.displayName;
            document.getElementById("anonymous").innerHTML = myuser.isAnonymous;
            document.getElementById("email").innerHTML = myuser.email;
            document.getElementById("photo").src = myuser.photoURL;
            document.getElementById("uid").innerHTML = myuser.uid;
        }

        function loadUserData() {
            firebase.database().ref('/users/'+myuser.uid).once('value').then(function(snapshot) {
                userData = snapshot.val();
                var userDataEl = document.getElementById("userData");
                userDataEl.innerHTML = JSON.stringify(userData);
                console.log("Loaded user data:",userData);
            });
        }

        console.log("End");

        function addItem() {
            console.log("Adding an item!");
            if (!userData) {
                userData = {};
                userData.cart = {};
                userData.cart["01003610"] = 1;
            } else {
                var count = userData.cart["01003610"];
                if (!count) {
                    count = 1;
                } else {
                    count ++;
                }
                userData.cart["01003610"] = count;
            }

            console.log("userData:",userData);
            firebase.database().ref('users/' + myuser.uid).set(userData);
            loadUserData();
        }
    </script>
  </body>
</html>
